;f5.asm
 
EnterTextBuffer:
;если размер текста в text_buf = 0 ,то -
       cmp      dword [SizeTextSelect],0
       jnz      .enter_t_b
 
;проверяем существование файла c:\temp\emd.tmp
;load text_buf
 call LoadTBFile
 
.enter_t_b:
       beep
 
;11:05 30.09.08<здесь проверяем в
;пределах текста, или в конце, нужно вставить блок
 
       xor      eax,eax
       mov      al,[y]
       inc      al
       imul     ax,CHAR_ON_LINE
       add      eax,dword [IndexPageActive]
       cmp      eax,dword [SizeTextFormatted]
       jb       .normal_enter_block;все нормально
 
       mov      eax,dword [SizeTextFormatted]
       add      eax,dword [StartMemory]
       mov      edi,eax
 
       mov      eax,dword [SizeTextSelect];увеличиваем размер текста
       add      [SizeTextFormatted],dword eax
 
       mov      esi,[ptrCopyPasteBuffer]
       mov      ecx,[SizeTextSelect]
 
call movsbVersion32
ret
 
.normal_enter_block:
       xor      eax,eax
       mov      al,[y]
       imul     ax,CHAR_ON_LINE
       add      eax,[StartMemory]
       add      eax,[IndexPageActive]
       mov      ebx,eax
       mov      esi,[SizeTextFormatted]
       add      esi,[StartMemory]
       mov      edi,esi
       add      edi,[SizeTextSelect]
       cmp      edi,[EndMemory]
       jae      .close ;error memory is end
 
.shift_text_for_enter_text_block:
       mov      al,[esi]
       mov      [edi],al
       dec      esi
       dec      edi
       cmp      esi,ebx
       jae      .shift_text_for_enter_text_block
       mov      eax,[SizeTextSelect]
       add      [SizeTextFormatted],eax
 
       xor      eax,eax
       mov      al,[y]
;inc al
       imul     ax,CHAR_ON_LINE
       add      eax,[StartMemory]
       add      eax,[IndexPageActive]
       mov      edi,eax
 
       mov      esi,[ptrCopyPasteBuffer]
       mov      ecx,[SizeTextSelect]
call movsbVersion32
clc
ret
 .close: ;error memory is end
stc
ret
 
 
;EOF
