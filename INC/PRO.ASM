;pro.asm
;Официально рекомендованный способ вызова инструкции rdtsc для измерения времени

StartProf:

xor eax,eax          ; вызываем машинную команду cpuid,
cpuid                ; после выполнения которой все
                     ; предыдущие машинные инструкции
                     ; гарантированно сошли к конвейера
                     ; и потому никак не могут повлиять
                     ; на результаты наших замеров

rdtsc                ; вызываем инструкцию rdtsc, которая
                     ; возвращает в регистре eax младшее
                     ; двойное слово текущего значения
                     ; time stamp counter 'a

mov [clock],eax      ; сохраняем полученное только что
                     ; значение в переменной clock

ret

;// ...               ; \
;// профилируемый код ; <- здесь исполняется профилируемый код
;// ...               ; /

EndProf:


xor eax,eax          ; еще раз выполняем команду cpuid,
cpuid                ; чтобы все предыдущие инструкции
                     ; гарантированно успели покинуть
                     ; конвейер

rdtsc                ; вызываем инструкцию rdtsc для чтения
                     ; нового значение time stamp count

sub eax,[clock]      ; вычисляем разность второго и первого
                     ; замеров, тем самым определяя реальное
                     ; время выполнения профилируемого
                     ; фрагмента кода

mov [NewClock],eax
mov ebx,[ProClock]
cmp eax,ebx
ja .l1

mov [ProClock],eax

.l1:

ret
NewClock dd 0
ProClock dd 0xffffff

clock dd 0

;EOF
